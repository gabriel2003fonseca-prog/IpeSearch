<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Favicon -->
    <link rel="icon" href="https://gabriel2003fonseca-prog.github.io/IpeSearch/logo2.png?v=1" type="image/png">

    <title>Pesquisar - IPÊ SEARCH</title>
    <link rel="stylesheet" href="style.css">

    <style>
        .search-section { background-color: #003366; }
    </style>
</head>

<body>

<header>
    <a href="index.html" class="logo-link">
        <img src="logo.png" alt="Logo IPÊ SEARCH" class="logo-img">
    </a>
    <a href="index.html" class="btn-voltar-home">INÍCIO</a>
</header>

<div id="search-view">

<section class="search-section">
    <video class="video-bg" autoplay muted loop playsinline>
        <source src="video.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>

    <div class="search-content-wrapper">
        <h1 class="search-title">Encontre Professores da UFLA</h1>

        <div class="input-wrapper">
            <div class="search-icon-left">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                     fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </div>

            <input type="text" id="searchInput" placeholder="Busque por nome, área, departamento...">

            <button id="clearBtn" class="btn-clear hidden" type="button" aria-label="Limpar pesquisa">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                     fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="quick-tags-container">
            <button class="tag-btn" onclick="filtrarTag('Agronomia')">Agronomia</button>
            <button class="tag-btn" onclick="filtrarTag('Zootecnia')">Zootecnia</button>
            <button class="tag-btn" onclick="filtrarTag('Veterinária')">Veterinária</button>
            <button class="tag-btn" onclick="filtrarTag('Engenharia')">Engenharias</button>
            <button class="tag-btn" onclick="filtrarTag('Computação')">Computação</button>
            <button class="tag-btn" onclick="filtrarTag('Direito')">Direito</button>
            <button class="tag-btn" onclick="filtrarTag('Medicina')">Medicina</button>
            <button class="tag-btn" onclick="filtrarTag('Biologia')">Biologia</button>
            <button class="tag-btn" onclick="filtrarTag('Química')">Química</button>
            <button class="tag-btn" onclick="filtrarTag('Física')">Física</button>
            <button class="tag-btn" onclick="filtrarTag('Matemática')">Matemática</button>
        </div>

        <p style="margin-top:25px;color:#003366;font-size:.95rem;font-weight:600;">
            Toque em uma área acima ou digite para pesquisar.
        </p>
    </div>
</section>

<div id="counter" style="text-align:center;margin-top:30px;"></div>
<div id="loading" style="display:none;text-align:center;padding:20px;color:#003366;">
    Carregando dados...
</div>

<div class="results-container" id="resultsContainer"></div>
</div>

<!-- PERFIL -->
<div id="profile-view" class="hidden">
    <div style="height:100px;"></div>

    <button class="btn-text-back" onclick="fecharPerfil()">← Voltar para a pesquisa</button>

    <div class="profile-card">
        <h1 id="prof-nome"></h1>
        <span id="prof-dept"></span>

        <p><strong>Email:</strong> <a id="prof-email"></a></p>
        <p><strong>Telefone:</strong> <span id="prof-tel"></span></p>
        <p><strong>Área:</strong> <span id="prof-area"></span></p>
        <p><strong>Subárea:</strong> <span id="prof-subarea"></span></p>

        <h3>Apresentação</h3>
        <div id="prof-apresentacao"></div>

        <h3>Projetos</h3>
        <div id="prof-projetos"></div>

        <small id="prof-update"></small>
    </div>
</div>

<div id="footer-placeholder"></div>

<!-- VLibras -->
<div vw class="enabled">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper>
        <div class="vw-plugin-top-wrapper"></div>
    </div>
</div>

<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script>
    new window.VLibras.Widget('https://vlibras.gov.br/app');
</script>

<!-- SCRIPT PRINCIPAL -->
<script>
const SHEET_ID = "1z5mSdyLnJG7zZc6y4E6aarPQtN2k2rDKLQDS38wd_sA";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
let dados = [];

function removerAcentos(t){
    return t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase() : "";
}

window.onload = async () => {
    document.getElementById("loading").style.display = "block";
    const res = await fetch(CSV_URL + "&t=" + Date.now());
    const txt = await res.text();
    dados = processarCSVRobusto(txt);
    document.getElementById("loading").style.display = "none";
    renderizar(dados);
};

function filtrarTag(tag){
    document.getElementById("searchInput").value = tag;
    filtrar(tag);
}

document.getElementById("searchInput").addEventListener("input", e => {
    filtrar(e.target.value);
});

function filtrar(termo){
    const t = removerAcentos(termo);
    const r = dados.filter(p =>
        removerAcentos(`${p.Nome} ${p.Departamento} ${p.Area}`).includes(t)
    );
    renderizar(r);
}

function renderizar(lista){
    const c = document.getElementById("resultsContainer");
    const counter = document.getElementById("counter");
    c.innerHTML = "";
    counter.innerText = `${lista.length} resultados encontrados`;

    lista.forEach(p => {
        const d = document.createElement("div");
        d.className = "card";
        d.onclick = () => abrirPerfil(p);
        d.innerHTML = `<h3>${p.Nome}</h3><p>${p.Departamento}</p><small>${p.Area}</small>`;
        c.appendChild(d);
    });
}

function abrirPerfil(p){
    document.getElementById("search-view").classList.add("hidden");
    document.getElementById("profile-view").classList.remove("hidden");

    prof-nome.innerText = p.Nome;
    prof-dept.innerText = p.Departamento;
    prof-email.innerText = p.Email || "Não informado";
    prof-email.href = p.Email ? `mailto:${p.Email}` : "#";
    prof-tel.innerText = p.Telefone || "N/A";
    prof-area.innerText = p.Area || "-";
    prof-subarea.innerText = p.Subarea || "-";
    prof-apresentacao.innerText = p.Apresentacao || "Sem biografia";
    prof-projetos.innerText = p.Projetos || "Sem projetos";
    prof-update.innerText = p.UltimaAtualizacao || "";
}

function fecharPerfil(){
    profile-view.classList.add("hidden");
    search-view.classList.remove("hidden");
}

function processarCSVRobusto(txt){
    const linhas = txt.split("\n").slice(1);
    return linhas.map(l => {
        const c = l.split(",");
        return {
            UltimaAtualizacao: c[0],
            Nome: c[1],
            Departamento: c[2],
            Email: c[3],
            Telefone: c[4],
            Area: c[5],
            Subarea: c[6],
            Projetos: c[8],
            Apresentacao: c[9]
        };
    });
}
</script>

</body>
</html>
